---
- name: Wait for SSH port
  hosts: tag_proxies
  gather_facts: false
  tasks:
    - name: Wait for new SSH port
      delegate_to: localhost
      wait_for:
        delay: 1
        port: "{{ ssh_port }}"
        timeout: 180
        state: started
        host: "{{ ansible_host }}"

- name: Configure Proxy Server
  hosts: tag_proxies
  become: true
  #vars:
  #  ansible_port: "{{ ssh_port }}"
  tasks:
    - name: Install Squid
      apt:
        name: squid
        update_cache: yes

    - name: Configure Squid
      template:
        src: templates/squid.conf.j2
        dest: /etc/squid/squid.conf

    - name: Install apache2-utils for htpasswd
      apt:
        name: apache2-utils
        state: present

    - name: Create auth file
      shell: |
        htpasswd -bc /etc/squid/passwd morph '{{ proxy_password }}'
        chown proxy:proxy /etc/squid/passwd
        chmod 640 /etc/squid/passwd

    - name: restart squid
      service:
        name: squid
        state: restarted

    - name: Wait for new proxy port
      wait_for:
        port: "{{ proxy_port }}"
        timeout: 180
        state: started

    - name: Install security packages
      apt:
        name:
          - fail2ban
          - ufw
          - auditd
        state: present

    - name: Configure fail2ban for squid
      copy:
        dest: /etc/fail2ban/jail.d/squid.conf
        content: |
          [squid]
          enabled = true
          filter = squid
          logpath = /var/log/squid/access.log
          maxretry = 3
          findtime = 600
          bantime = 3600

    - name: Configure UFW
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "{{ ssh_port }}"
        - "{{ proxy_port }}"

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny
