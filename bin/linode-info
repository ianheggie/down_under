#!/usr/bin/python3
# vi: ft=python

import urllib.request
import base64
import os
import json
import re
import requests




if os.path.isdir("ansible"):
    os.chdir('ansible')

non_alpha_numeric = re.compile(r"[^a-zA-Z0-9]+", re.IGNORECASE)

api_key = f"&api_key={os.environ['LINODE_TOKEN']}"

with open('vars/linode.yml', 'w') as out:
    print('# ============================================================', file=out)
    print('# Linode constants - generated by linode-info', file=out)
    print('', file=out)
    print('#---------------------------', file=out)
    print('Linode_regions:', file=out)
    url = "https://api.linode.com/v4/regions"
    headers = {"accept": "application/json"}
    print(url)
    response = requests.get(url, headers=headers)
    print(response.text)
    list = json.loads(response.text)['data']

    for rec in list:
        print(f'  "{rec["ABBR"]}:"', file=out)
        for subkey, value in rec.items():
            print(f'    "{subkey}": {value}', file=out)

    print('', file=out)
    print('#---------------------------', file=out)
    print('# Linode distributions:', file=out)
    print('', file=out)
    print('Linode_Distributions:', file=out)
    data = urllib.request.urlopen(f'https://api.linode.com/?api_action=avail.distributions{api_key}').read()
    list = json.loads(data)['DATA']

    for rec in list:
        print(f'  "{rec["LABEL"]}:"', file=out)
        for subkey, value in rec.items():
            print(f'    "{subkey}": {value}', file=out)

    print('#---------------------------', file=out)
    print('# Linode plans:', file=out)
    print('Linode_Plans:', file=out)

    data = urllib.request.urlopen(f'https://api.linode.com/?api_action=avail.linodeplans{api_key}').read()
    list = json.loads(data)['DATA']

    for rec in list:
        print(f'  "{rec["LABEL"]}:"', file=out)
        for subkey, value in rec.items():
            print(f'    "{subkey}": {value}', file=out)
