# create.yml
---
# create.yml
- name: Create Australian Proxy
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars/all.yml
  tasks:
    - name: Create Linode instance
      community.general.linode:
        api_key: "{{ lookup('env', 'LINODE_TOKEN') }}"
        name: "au-proxy"
        distribution: "linode/ubuntu22.04"  # Changed from image
        datacenter: "{{ region }}"          # Changed from region
        plan: "{{ linode_type }}"           # Changed from type
        ssh_pub_key: "{{ lookup('file', '~/.ssh/id_ed25519.pub', errors='ignore') or lookup('file', '~/.ssh/id_rsa.pub') }}"  # Changed from authorized_keys
        state: present
      register: linode

    - name: Set proxy IP
      set_fact:
        proxy_ip: "{{ linode.instance.ipv4[0] }}"

    - name: Update DNS record
      uri:
        url: "https://api.linode.com/v4/domains/{{ proxy_domain.split('.')[-2:] | join('.') }}/records"
        method: POST
        headers:
          Authorization: "Bearer {{ lookup('env', 'LINODE_TOKEN') }}"
        body_format: json
        body:
          type: "A"
          name: "{{ proxy_domain.split('.')[0] }}"
          target: "{{ proxy_ip }}"
          ttl: 300
        status_code: [200, 201]

    - name: Wait for SSH
      wait_for:
        host: "{{ proxy_ip }}"
        port: 22
        delay: 10
        timeout: 300

    - name: Add host to inventory
      add_host:
        name: proxy
        groups: proxy
        ansible_host: "{{ proxy_ip }}"

- name: Configure proxy server
  hosts: proxy
  become: true
  tasks:
    - name: Install Squid
      apt:
        name: squid
        update_cache: yes

    - name: Configure Squid
      template:
        src: templates/squid.conf.j2
        dest: /etc/squid/squid.conf
      notify: restart squid

    - name: Create auth file
      htpasswd:
        path: /etc/squid/passwd
        name: morph
        password: "{{ proxy_password }}"
        owner: proxy
        group: proxy
        mode: '0640'
      notify: restart squid

  handlers:
    - name: restart squid
      service:
        name: squid
        state: restarted

